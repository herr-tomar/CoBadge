package osplus.pkptuna.hazelcast.pubsub;

import com.hazelcast.collection.IQueue;
import com.hazelcast.core.HazelcastInstance;
import jakarta.annotation.PostConstruct;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.scheduling.annotation.Async;
import osplus.apl.core.api.AplComponent;
import osplus.pkptuna.dispute.lookup.model.DisputeLookupRequestWrapperDto;
import osplus.pkptuna.dispute.lookup.model.DisputeLookupResponseDto;
import osplus.pkptuna.dispute.lookup.model.DisputeLookupResponseWrapperDto;
import osplus.pkptuna.dispute.service.DisputeService;
import osplus.pkptuna.hazelcast.configprops.DisputeLookupQueueProps;
import osplus.pkptuna.hazelcast.protobuf.SimpleDeserializer;
import osplus.pkptuna.hazelcast.protobuf.impl.ProtobufDeserializer;
import osplus.pkptuna.hazelcast.protobuf.impl.ProtobufSerializer;

import java.util.List;

@AplComponent
public class DisputeLookupQueueConsumer {

    private static final Logger LOGGER = LoggerFactory.getLogger(DisputeLookupQueueConsumer.class);

    private final HazelcastInstance hazelcastInstance;
    private final DisputeService disputeService;
    private final List<Integer> partitionIndices;
    private final String baseQueueName;
    private final CustomHazelcastReliableTopicPublisher<DisputeLookupResponseWrapperDto> responsePublisher;
    private final SimpleDeserializer<DisputeLookupRequestWrapperDto> deserializer;

    public DisputeLookupQueueConsumer(
            HazelcastInstance hazelcastInstance,
            DisputeService disputeService,
            DisputeLookupQueueProps queueProps
    ) {
        this.hazelcastInstance = hazelcastInstance;
        this.disputeService = disputeService;
        this.partitionIndices = queueProps.partitions(); // List of queue partitions
        this.baseQueueName = queueProps.base();
        this.deserializer = new ProtobufDeserializer<>(DisputeLookupRequestWrapperDto.parser());
        this.responsePublisher = new CustomHazelcastReliableTopicPublisher<>(
                hazelcastInstance,
                new ProtobufSerializer<DisputeLookupResponseWrapperDto>()
        );
    }

    @PostConstruct
    public void startConsumers() {
        partitionIndices.forEach(this::startAsyncConsumer);
    }

    @Async("queueExecutor")
    public void startAsyncConsumer(Integer partition) {
        String queueName = baseQueueName + partition;
        LOGGER.info("Started async consumer for queue: {}", queueName);
        runInternal(queueName);
    }

    private void runInternal(String queueName) {
        try {
            IQueue<byte[]> queue = hazelcastInstance.getQueue(queueName);
            while (true) {
                byte[] message = queue.take();
                DisputeLookupRequestWrapperDto request = deserializer.deserialize(message);

                DisputeLookupResponseDto result = disputeService.lookupDisputeFolder(
                        request.getIssuerId(),
                        request.getCardReference()
                );

                DisputeLookupResponseWrapperDto response = DisputeLookupResponseWrapperDto.newBuilder()
                        .setCorrelationId(request.getCorrelationId())
                        .setResponse(result)
                        .build();

                responsePublisher.sendMessage("DisputeResponseReliableTopic", "DISPUTE_WORKER", response);
                LOGGER.info("Responded to correlationId: {}", request.getCorrelationId());
            }
        } catch (Exception e) {
            LOGGER.error("Error in DisputeLookupQueueConsumer [{}]: {}", queueName, e.getMessage(), e);
        }
    }
}
