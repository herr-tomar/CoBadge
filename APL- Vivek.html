package osplus.pkptuna.flows.bootstrap;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import osplus.pkptuna.hazelcast.flows.FlowHandlerRegistry;
import osplus.pkptuna.hazelcast.pubsub.GenericHazelcastConsumer;
import osplus.pkptuna.hazelcast.pubsub.GenericHazelcastRouter;
import osplus.pkptuna.hazelcast.pubsub.FlowConfig;

import java.util.List;
import java.util.stream.Collectors;

@Configuration
public class FlowHandlerInitializer {

    @Bean
    public List<FlowConfig> hazelcastFlowConfigs(HazelcastFlowConfigs external) {
        return external.flows().stream()
            .map(c -> new FlowConfig(
                c.name(),
                c.requestTopic(),
                c.responseTopic(),
                c.mapBase(),
                c.partitions()
            ))
            .collect(Collectors.toList());
    }

    @Bean
    public GenericHazelcastRouter hazelcastRouter(
            HazelcastInstance hazelcastInstance,
            List<FlowConfig> flowConfigs,
            FlowHandlerRegistry<?, ?> registry) {
        return new GenericHazelcastRouter(hazelcastInstance, flowConfigs, registry);
    }

    @Bean
    public GenericHazelcastConsumer hazelcastConsumer(
            HazelcastInstance hazelcastInstance,
            TaskScheduler scheduler,
            List<FlowConfig> flowConfigs,
            FlowHandlerRegistry<?, ?> registry) {
        return new GenericHazelcastConsumer(hazelcastInstance, scheduler, flowConfigs, registry);
    }
}
