package osplus.pkptuna.dispute.util;

import com.google.protobuf.InvalidProtocolBufferException;
import com.google.protobuf.Message;
import com.google.protobuf.util.JsonFormat;

public class ProtobufJsonUtil {

    private ProtobufJsonUtil() {
    }

    public static <T extends Message.Builder> T parseJsonToProto(String json, T builder) {
        try {
            JsonFormat.parser()
                    .ignoringUnknownFields()
                    .merge(json, builder);
            return builder;
        } catch (InvalidProtocolBufferException e) {
            throw new IllegalArgumentException("Failed to parse JSON into protobuf DTO", e);
        }
    }

    public static String fixTimestamps(String json) {
        return json.replaceAll(
                "(\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{3})([+-])(\\d{2})(\\d{2})",
                "$1$2$3:$4"
        );
    }

    public static String printProtoToJson(Message protoMessage) {
        try {
            return JsonFormat.printer()
                    .includingDefaultValueFields()
                    .print(protoMessage);
        } catch (InvalidProtocolBufferException e) {
            throw new IllegalStateException("Failed to serialize protobuf DTO to JSON", e);
        }
    }

}


-------------------------------

package osplus.pkptuna.dispute.config;

import org.springframework.boot.context.properties.ConfigurationProperties;

@ConfigurationProperties(prefix = "dispute")
public record DisputeServiceProperties(
        Auth auth,
        Paths paths,
        String baseUrl
) {

    public record Auth(String username, String password) {
    }

    public record Paths(String lookupDisputes, String disputeDetails) {
    }
}


-----------------------

package osplus.pkptuna.dispute.config;

import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpHeaders;
import org.springframework.web.reactive.function.client.WebClient;
import osplus.pkptuna.dispute.service.DisputeDetailService;
import osplus.pkptuna.dispute.service.DisputeService;
import osplus.pkptuna.dispute.service.impl.DisputeDetailServiceImpl;
import osplus.pkptuna.dispute.service.impl.DisputeServiceImpl;

@Configuration
@EnableConfigurationProperties(DisputeServiceProperties.class)
public class DisputeConfig {

    @Bean
    public WebClient disputeWebClient(DisputeServiceProperties props) {
        return WebClient.builder()
                .baseUrl(props.baseUrl())
                .defaultHeader(HttpHeaders.CONTENT_TYPE, "application/json")
                .build();
    }

    @Bean
    public DisputeService disputeService(WebClient disputeWebClient, DisputeServiceProperties props) {
        return new DisputeServiceImpl(disputeWebClient, props);
    }

    @Bean
    public DisputeDetailService disputeDetailService(WebClient disputeWebClient, DisputeServiceProperties props) {
        return new DisputeDetailServiceImpl(disputeWebClient, props);
    }

}
