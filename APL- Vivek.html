package osplus.pkptuna.uimodule;

import com.hazelcast.core.HazelcastInstance;
import com.hazelcast.topic.ITopic;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mapstruct.factory.Mappers;
import org.springframework.http.ResponseEntity;
import osplus.pkptuna.api.ApiResponse;
import osplus.pkptuna.dispute.lookup.model.DisputeLookupRequestWrapperDto;
import osplus.pkptuna.dispute.lookup.model.DisputeLookupResponseDto;
import osplus.pkptuna.dispute.model.DisputeDetailRequestWrapperDto;
import osplus.pkptuna.dispute.model.DisputeResponseDto;
import osplus.pkptuna.dispute.service.DisputeDetailService;
import osplus.pkptuna.dispute.service.DisputeService;
import osplus.pkptuna.rest.dispute.lookup.model.mapper.DisputeLookupResponseDtoMapper;
import osplus.pkptuna.rest.dispute.model.mapper.DisputeResponseDtoMapper;
import osplus.pkptuna.util.GenericResponseTracker;

import java.util.Arrays;
import java.util.UUID;
import java.util.concurrent.CompletableFuture;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

class DisputeUiModuleTest {

    private DisputeUiModule disputeUiModule;
    private DisputeService disputeService;
    private DisputeDetailService disputeDetailService;
    private HazelcastInstance hazelcastInstance;

    private GenericResponseTracker<DisputeLookupResponseDto> disputeLookupResponseTracker;
    private GenericResponseTracker<DisputeResponseDto> disputeDetailResponseTracker;

    private DisputeLookupResponseDtoMapper disputeLookupResponseDtoMapper;
    private DisputeResponseDtoMapper disputeResponseDtoMapper;

    @BeforeEach
    void setUp() {
        disputeService = mock(DisputeService.class);
        disputeDetailService = mock(DisputeDetailService.class);
        hazelcastInstance = mock(HazelcastInstance.class);

        disputeLookupResponseTracker = mock(GenericResponseTracker.class);
        disputeDetailResponseTracker = mock(GenericResponseTracker.class);

        disputeLookupResponseDtoMapper = mock(DisputeLookupResponseDtoMapper.class);
        disputeResponseDtoMapper = mock(DisputeResponseDtoMapper.class);

        disputeUiModule = new DisputeUiModule(
                hazelcastInstance,
                disputeService,
                disputeDetailService,
                disputeDetailResponseTracker,
                disputeLookupResponseTracker,
                disputeLookupResponseDtoMapper,
                disputeResponseDtoMapper
        );
    }

    @Test
    void testLookupDisputeFolder() {
        DisputeLookupResponseDto protoResponse = DisputeLookupResponseDto.getDefaultInstance();
        when(disputeService.lookupDisputeFolder(anyString(), anyString())).thenReturn(protoResponse);
        when(disputeLookupResponseDtoMapper.toRestDto(protoResponse)).thenReturn(new osplus.pkptuna.rest.dispute.lookup.model.DisputeLookupResponseDto());

        ResponseEntity<ApiResponse<osplus.pkptuna.rest.dispute.lookup.model.DisputeLookupResponseDto>> response =
                disputeUiModule.lookupDisputeFolder("issuer", "cardRef");

        assertEquals(200, response.getStatusCodeValue());
        assertNotNull(response.getBody());
        assertEquals("success", response.getBody().getStatus());
    }

    @Test
    void testGetDisputeDetails() {
        DisputeResponseDto protoResponse = DisputeResponseDto.getDefaultInstance();
        when(disputeDetailService.getDisputeFolderDetails(anyString(), anyString(), any())).thenReturn(protoResponse);
        when(disputeResponseDtoMapper.toRestDto(protoResponse)).thenReturn(new osplus.pkptuna.rest.dispute.model.DisputeResponseDto());

        ResponseEntity<ApiResponse<osplus.pkptuna.rest.dispute.model.DisputeResponseDto>> response =
                disputeUiModule.getDisputeDetails("issuer", "ref", "events,postings");

        assertEquals(200, response.getStatusCodeValue());
        assertNotNull(response.getBody());
        assertEquals("success", response.getBody().getStatus());
    }

    @Test
    @SuppressWarnings("unchecked")
    void testPublishDisputesLookupRequest() throws Exception {
        DisputeLookupResponseDto protoResponse = DisputeLookupResponseDto.getDefaultInstance();
        when(hazelcastInstance.getReliableTopic(anyString())).thenReturn(mock(ITopic.class));

        CompletableFuture<DisputeLookupResponseDto> future = new CompletableFuture<>();
        future.complete(protoResponse);
        when(disputeLookupResponseTracker.await(anyString())).thenReturn((CompletableFuture) future);

        when(disputeLookupResponseDtoMapper.toRestDto(protoResponse)).thenReturn(new osplus.pkptuna.rest.dispute.lookup.model.DisputeLookupResponseDto());

        ResponseEntity<ApiResponse<osplus.pkptuna.rest.dispute.lookup.model.DisputeLookupResponseDto>> response =
                disputeUiModule.publishDisputesLookupRequest("issuer", "cardRef");

        assertEquals(200, response.getStatusCodeValue());
        assertEquals("success", response.getBody().getStatus());
    }

    @Test
    @SuppressWarnings("unchecked")
    void testPublishDisputeDetailRequest() throws Exception {
        DisputeResponseDto protoResponse = DisputeResponseDto.getDefaultInstance();
        when(hazelcastInstance.getReliableTopic(anyString())).thenReturn(mock(ITopic.class));

        CompletableFuture<DisputeResponseDto> future = new CompletableFuture<>();
        future.complete(protoResponse);
        when(disputeDetailResponseTracker.await(anyString())).thenReturn((CompletableFuture) future);

        when(disputeResponseDtoMapper.toRestDto(protoResponse)).thenReturn(new osplus.pkptuna.rest.dispute.model.DisputeResponseDto());

        ResponseEntity<ApiResponse<osplus.pkptuna.rest.dispute.model.DisputeResponseDto>> response =
                disputeUiModule.publishDisputeDetailRequest("issuer", "folder123", "events,documents");

        assertEquals(200, response.getStatusCodeValue());
        assertEquals("success", response.getBody().getStatus());
    }
}
