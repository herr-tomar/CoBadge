package osplus.pkptuna.flows.handlers;

import com.hazelcast.core.HazelcastInstance;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import osplus.pkptuna.dispute.model.*;

import osplus.pkptuna.dispute.service.DisputeDetailService;

import java.util.List;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.mockito.Mockito.when;

/**
 * Testklasse für {@link DisputeDetailFlowHandler}.
 * Überprüft das Extrahieren der Korrelation-ID, den Aufruf des Service und das Verpacken der Antwort.
 */
@ExtendWith(MockitoExtension.class)
class DisputeDetailFlowHandlerTest {

    @Mock
    private DisputeDetailService disputeDetailService;

    @Mock
    private HazelcastInstance hazelcastInstance;

    private DisputeDetailFlowHandler handler;

    @BeforeEach
    void setUp() {
        handler = new DisputeDetailFlowHandler(disputeDetailService);
    }

    /**
     * Testet die Extraktion der Korrelation-ID aus dem Request.
     */
    @Test
    void shouldExtractCorrelationId() {
        DisputeDetailRequestWrapperDto request = DisputeDetailRequestWrapperDto.newBuilder()
                .setCorrelationId("12345")
                .build();

        String result = handler.extractCorrelationId(request);

        assertEquals("12345", result);
    }

    /**
     * Testet, ob der Handler den Service mit korrekten Parametern aufruft.
     */
    @Test
    void shouldHandleRequestAndCallService() {
        DisputeDetailRequestDto payload = DisputeDetailRequestDto.newBuilder()
                .setIssuerId("issuer")
                .setDisputeFolderReference("ref")
                .setMetadata(DisputeDetailRequestMetadataDto.newBuilder().addEmbed("x"))
                .build();

        DisputeDetailRequestWrapperDto request = DisputeDetailRequestWrapperDto.newBuilder()
                .setPayload(payload)
                .build();

        DisputeResponseDto expectedResponse = DisputeResponseDto.newBuilder().build();
        when(disputeDetailService.getDisputeFolderDetails("issuer", "ref", List.of("x")))
                .thenReturn(expectedResponse);

        DisputeResponseDto response = handler.handleRequest(request);

        assertEquals(expectedResponse, response);
    }

    /**
     * Testet, ob das Response-Objekt korrekt verpackt wird.
     */
    @Test
    void shouldWrapResponseCorrectly() {
        DisputeResponseDto response = DisputeResponseDto.newBuilder().build();
        Object wrapped = handler.wrapResponse("abc", response);

        assertTrue(wrapped instanceof DisputeDetailResponseWrapperDto);
        assertEquals("abc", ((DisputeDetailResponseWrapperDto) wrapped).getCorrelationId());
    }
}

-----------------

package osplus.pkptuna.flows.handlers;

import com.hazelcast.core.HazelcastInstance;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import osplus.pkptuna.dispute.lookup.model.*;
import osplus.pkptuna.dispute.service.DisputeService;

import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.mockito.Mockito.when;

/**
 * Testklasse für {@link DisputeLookupFlowHandler}.
 * Validiert das Extrahieren der Korrelation-ID, den Lookup-Aufruf sowie das Verpacken der Antwort.
 */
@ExtendWith(MockitoExtension.class)
class DisputeLookupFlowHandlerTest {

    @Mock
    private DisputeService disputeService;

    @Mock
    private HazelcastInstance hazelcastInstance;

    private DisputeLookupFlowHandler handler;

    @BeforeEach
    void setUp() {
        handler = new DisputeLookupFlowHandler(disputeService);
    }

    /**
     * Testet die Extraktion der Korrelation-ID aus dem Wrapper.
     */
    @Test
    void shouldExtractCorrelationId() {
        DisputeLookupRequestWrapperDto request = DisputeLookupRequestWrapperDto.newBuilder()
                .setCorrelationId("lookup-001")
                .build();

        String result = handler.extractCorrelationId(request);

        assertEquals("lookup-001", result);
    }

    /**
     * Testet, ob der Lookup-Service korrekt aufgerufen wird.
     */
    @Test
    void shouldCallLookupService() {
        DisputeLookupRequestDto dto = DisputeLookupRequestDto.newBuilder()
                .setIssuerId("issuer")
                .setCardReference("cardRef")
                .build();

        DisputeLookupRequestWrapperDto request = DisputeLookupRequestWrapperDto.newBuilder()
                .setPayload(dto)
                .build();

        DisputeLookupResponseDto expected = DisputeLookupResponseDto.newBuilder().build();
        when(disputeService.lookupDisputeFolder("issuer", "cardRef")).thenReturn(expected);

        DisputeLookupResponseDto actual = handler.handleRequest(request);

        assertEquals(expected, actual);
    }

    /**
     * Testet das korrekte Verpacken des Lookup-Antwortobjekts.
     */
    @Test
    void shouldWrapResponseCorrectly() {
        DisputeLookupResponseDto response = DisputeLookupResponseDto.newBuilder().build();
        Object wrapped = handler.wrapResponse("corr-id", response);

        assertTrue(wrapped instanceof DisputeLookupResponseWrapperDto);
        assertEquals("corr-id", ((DisputeLookupResponseWrapperDto) wrapped).getCorrelationId());
    }
}
