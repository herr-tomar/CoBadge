package osplus.pkptuna.hazelcast.flow;

import osplus.pkptuna.dispute.lookup.model.DisputeLookupRequestWrapperDto;
import osplus.pkptuna.dispute.lookup.model.DisputeLookupResponseDto;
import osplus.pkptuna.dispute.lookup.model.DisputeLookupResponseWrapperDto;
import osplus.pkptuna.dispute.service.DisputeService;
import osplus.pkptuna.hazelcast.framework.FlowHandler;
import osplus.pkptuna.hazelcast.protobuf.impl.ProtobufSerializer;
import org.springframework.stereotype.Component;

@Component
public class DisputeLookupFlowHandler implements FlowHandler<DisputeLookupRequestWrapperDto, DisputeLookupResponseWrapperDto> {

    private final DisputeService disputeService;
    private final ProtobufSerializer<DisputeLookupResponseWrapperDto> serializer = new ProtobufSerializer<>();

    public DisputeLookupFlowHandler(DisputeService disputeService) {
        this.disputeService = disputeService;
    }

    @Override
    public DisputeLookupRequestWrapperDto deserializeRequest(byte[] data) throws Exception {
        return DisputeLookupRequestWrapperDto.parseFrom(data);
    }

    @Override
    public String extractCorrelationId(DisputeLookupRequestWrapperDto request) {
        return request.getCorrelationId();
    }

    @Override
    public String extractIssuerId(DisputeLookupRequestWrapperDto request) {
        return request.getIssuerId();
    }

    @Override
    public DisputeLookupResponseWrapperDto processRequest(DisputeLookupRequestWrapperDto request) {
        DisputeLookupResponseDto responseDto = disputeService.lookupDisputeFolder(
                request.getIssuerId(),
                request.getCardReference()
        );

        return DisputeLookupResponseWrapperDto.newBuilder()
                .setCorrelationId(request.getCorrelationId())
                .setResponse(responseDto)
                .build();
    }

    @Override
    public byte[] serializeResponse(DisputeLookupResponseWrapperDto response) throws Exception {
        return serializer.serialize(response);
    }
}
