package osplus.pkptuna.flows.handlers;

import com.google.protobuf.InvalidProtocolBufferException;
import com.hazelcast.core.HazelcastInstance;
import jakarta.annotation.PostConstruct;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import osplus.apl.core.api.AplComponent;
import osplus.pkptuna.dispute.model.DisputeDetailRequestDto;
import osplus.pkptuna.dispute.model.DisputeDetailRequestMetadataDto;
import osplus.pkptuna.dispute.model.DisputeDetailRequestWrapperDto;
import osplus.pkptuna.dispute.model.DisputeDetailResponseWrapperDto;
import osplus.pkptuna.dispute.model.DisputeResponseDto;
import osplus.pkptuna.dispute.service.DisputeDetailService;
import osplus.pkptuna.hazelcast.flows.FlowHandler;
import osplus.pkptuna.hazelcast.protobuf.impl.ProtobufSerializer;
import osplus.pkptuna.hazelcast.pubsub.ReliableTopicPublisher;

import java.util.List;

@AplComponent("dispute-detail")
public class DisputeDetailFlowHandler implements FlowHandler<DisputeDetailRequestWrapperDto, DisputeResponseDto> {

    private static final Logger LOGGER = LoggerFactory.getLogger(DisputeDetailFlowHandler.class);

    public static final String DISPUTE_DETAIL = "dispute-detail";
    private final DisputeDetailService disputeDetailService;

    public DisputeDetailFlowHandler(DisputeDetailService disputeService) {
        this.disputeDetailService = disputeService;
    }

    @Override
    public DisputeDetailRequestWrapperDto deserializeRequest(byte[] data) throws InvalidProtocolBufferException {
        return DisputeDetailRequestWrapperDto.parseFrom(data);
    }

    @Override
    public String extractCorrelationId(DisputeDetailRequestWrapperDto request) {
        return request.getCorrelationId();
    }

    @Override
    public DisputeResponseDto handleRequest(DisputeDetailRequestWrapperDto request) {
        DisputeDetailRequestDto disputeLookupRequestDto = request.getPayload();
        DisputeDetailRequestMetadataDto disputeDetailRequestMetadataDto = disputeLookupRequestDto.getMetadata();
        List<String> embeds = disputeDetailRequestMetadataDto.getEmbedList();
        return disputeDetailService.getDisputeFolderDetails(disputeLookupRequestDto.getIssuerId(), disputeLookupRequestDto.getDisputeFolderReference(), embeds);
    }

    @Override
    public Object wrapResponse(String correlationId, DisputeResponseDto result) {
        return DisputeDetailResponseWrapperDto.newBuilder()
                .setCorrelationId(correlationId)
                .setResponse(result)
                .build();
    }

    @Override
    public void sendResponse(HazelcastInstance hazelcastInstance, String topicName, Object response) {
        DisputeDetailResponseWrapperDto dto = (DisputeDetailResponseWrapperDto) response;
        new ReliableTopicPublisher<>(hazelcastInstance, new ProtobufSerializer<>()).sendMessage(topicName, "DISPUTE_ROUTER", dto);
    }

    @Override
    public String getFlowName(){
        return DISPUTE_DETAIL;
    }

    @PostConstruct
    public void init() {
        LOGGER.info("Loaded DisputeDetailFlowHandler code ...........");
    }

}

                ---------------------


                package osplus.pkptuna.flows.handlers;

import com.google.protobuf.InvalidProtocolBufferException;
import com.hazelcast.core.HazelcastInstance;
import jakarta.annotation.PostConstruct;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import osplus.apl.core.api.AplComponent;
import osplus.pkptuna.dispute.lookup.model.DisputeLookupRequestDto;
import osplus.pkptuna.dispute.lookup.model.DisputeLookupRequestWrapperDto;
import osplus.pkptuna.dispute.lookup.model.DisputeLookupResponseDto;
import osplus.pkptuna.dispute.lookup.model.DisputeLookupResponseWrapperDto;
import osplus.pkptuna.dispute.service.DisputeService;
import osplus.pkptuna.hazelcast.flows.FlowHandler;
import osplus.pkptuna.hazelcast.protobuf.impl.ProtobufSerializer;
import osplus.pkptuna.hazelcast.pubsub.ReliableTopicPublisher;

@AplComponent("dispute-lookup")
public class DisputeLookupFlowHandler implements FlowHandler<DisputeLookupRequestWrapperDto, DisputeLookupResponseDto> {

    private static final Logger LOGGER = LoggerFactory.getLogger(DisputeLookupFlowHandler.class);

    public static final String DISPUTE_LOOKUP = "dispute-lookup";
    private final DisputeService disputeService;

    public DisputeLookupFlowHandler(DisputeService disputeService) {
        this.disputeService = disputeService;
    }

    @Override
    public DisputeLookupRequestWrapperDto deserializeRequest(byte[] data) throws InvalidProtocolBufferException {
        return DisputeLookupRequestWrapperDto.parseFrom(data);
    }

    @Override
    public String extractCorrelationId(DisputeLookupRequestWrapperDto request) {
        return request.getCorrelationId();
    }

    @Override
    public DisputeLookupResponseDto handleRequest(DisputeLookupRequestWrapperDto request) {
        DisputeLookupRequestDto disputeLookupRequestDto = request.getPayload();
        return disputeService.lookupDisputeFolder(disputeLookupRequestDto.getIssuerId(), disputeLookupRequestDto.getCardReference());
    }

    @Override
    public Object wrapResponse(String correlationId, DisputeLookupResponseDto result) {
        return DisputeLookupResponseWrapperDto.newBuilder()
                .setCorrelationId(correlationId)
                .setResponse(result)
                .build();
    }

    @Override
    public void sendResponse(HazelcastInstance hazelcastInstance, String topicName, Object response) {
        DisputeLookupResponseWrapperDto dto = (DisputeLookupResponseWrapperDto) response;
        new ReliableTopicPublisher<>(hazelcastInstance, new ProtobufSerializer<>()).sendMessage(topicName, "DISPUTE_ROUTER", dto);
    }

    @Override
    public String getFlowName(){
        return DISPUTE_LOOKUP;
    }

    @PostConstruct
    public void init() {
        LOGGER.info("Loaded DisputeLookupFlowHandler code ...........");
    }

}
