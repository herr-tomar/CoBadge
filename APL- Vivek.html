package osplus.pkptuna.hazelcast.router;

import com.google.protobuf.InvalidProtocolBufferException;
import com.hazelcast.core.HazelcastInstance;
import com.hazelcast.map.IMap;
import com.hazelcast.topic.ITopic;
import com.hazelcast.topic.Message;
import com.hazelcast.topic.MessageListener;
import jakarta.annotation.PostConstruct;
import osplus.apl.core.api.AplComponent;
import osplus.fi.core.logging.api.Logger;
import osplus.fi.core.logging.api.LoggerFactory;
import osplus.pkptuna.dispute.lookup.model.DisputeLookupRequestWrapperDto;
import osplus.pkptuna.hazelcast.configprops.DisputeLookupReliableTopicProps;
import osplus.pkptuna.hazelcast.protobuf.SimpleDeserializer;
import osplus.pkptuna.hazelcast.protobuf.impl.ProtobufDeserializer;

import java.util.UUID;
import java.util.concurrent.TimeUnit;

@AplComponent
public class DisputeLookupRouter implements MessageListener<byte[]> {

    private static final Logger LOGGER = LoggerFactory.getLogger(DisputeLookupRouter.class);

    private final HazelcastInstance hazelcastInstance;
    private final SimpleDeserializer<DisputeLookupRequestWrapperDto> deserializer;
    private final String topicName;

    // Constants for map names
    private static final String REQUEST_MAP_NAME = "dispute-lookup-request-map";
    private static final String CLAIM_MAP_NAME = "router-claim-map";

    public DisputeLookupRouter(HazelcastInstance hazelcastInstance,
                               DisputeLookupReliableTopicProps topicProps) {

        this.hazelcastInstance = hazelcastInstance;
        this.topicName = topicProps.request();
        this.deserializer = new ProtobufDeserializer<>(DisputeLookupRequestWrapperDto.parser());
    }

    @PostConstruct
    public void start() {
        LOGGER.info("Topic Name: {}", topicName);
        ITopic<byte[]> topic = hazelcastInstance.getReliableTopic(topicName);
        topic.addMessageListener(this);
        LOGGER.info("DisputeRouter started. Listening on DisputeRequestReliableTopic...");
    }

    @Override
    public void onMessage(Message<byte[]> message) {
        try {
            DisputeLookupRequestWrapperDto requestWrapper =
                    deserializer.deserialize(message.getMessageObject());

            String correlationId = requestWrapper.getCorrelationId();
            String lockKey = "route-lock-" + correlationId;

            // Claim lock to prevent duplicate routing
            IMap<String, String> claimMap = hazelcastInstance.getMap(CLAIM_MAP_NAME);
            String lockToken = UUID.randomUUID().toString();
            String existing = claimMap.putIfAbsent(lockKey, lockToken);

            if (existing != null) {
                LOGGER.info("Duplicate correlationId detected, skipping: {}", correlationId);
                return;
            }

            // Store request in IMap with TTL (e.g., 5 minutes)
            IMap<String, DisputeLookupRequestWrapperDto> requestMap = hazelcastInstance.getMap(REQUEST_MAP_NAME);
            requestMap.put(correlationId, requestWrapper, 5, TimeUnit.MINUTES);

            LOGGER.info("Stored dispute request with correlationId={} in map '{}'", correlationId, REQUEST_MAP_NAME);

        } catch (InvalidProtocolBufferException e) {
            LOGGER.error("Deserialization error in DisputeRouter: {}", e.getMessage(), e);
        } catch (Exception e) {
            LOGGER.error("Error in DisputeRouter: {}", e.getMessage(), e);
        }
    }
}
