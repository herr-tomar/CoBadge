package osplus.pkptuna.hazelcast.router;

import com.google.protobuf.InvalidProtocolBufferException;
import com.hazelcast.core.HazelcastInstance;
import com.hazelcast.map.IMap;
import com.hazelcast.topic.ITopic;
import com.hazelcast.topic.Message;
import com.hazelcast.topic.MessageListener;
import jakarta.annotation.PostConstruct;
import osplus.apl.core.api.AplComponent;
import osplus.fi.core.logging.api.Logger;
import osplus.fi.core.logging.api.LoggerFactory;
import osplus.pkptuna.dispute.lookup.model.DisputeLookupRequestWrapperDto;
import osplus.pkptuna.hazelcast.configprops.DisputeLookupQueueProps;
import osplus.pkptuna.hazelcast.configprops.DisputeLookupReliableTopicProps;
import osplus.pkptuna.hazelcast.protobuf.SimpleDeserializer;
import osplus.pkptuna.hazelcast.protobuf.impl.ProtobufDeserializer;
import osplus.pkptuna.hazelcast.protobuf.impl.ProtobufSerializer;
import osplus.pkptuna.hazelcast.pubsub.CustomHazelcastQueuePublisher;

import java.util.List;
import java.util.UUID;

@AplComponent
public class DisputeLookupRouter implements MessageListener<byte[]> {

    private static final Logger LOGGER = LoggerFactory.getLogger(DisputeLookupRouter.class);

    private final HazelcastInstance hazelcastInstance;
    private final SimpleDeserializer<DisputeLookupRequestWrapperDto> deserializer;
    private final CustomHazelcastQueuePublisher publisher;
    private final List<Integer> partitionIndices;
    private final String topicName;
    private final String queueBase;

    public DisputeLookupRouter(HazelcastInstance hazelcastInstance,
                               DisputeLookupReliableTopicProps topicProps,
                               DisputeLookupQueueProps queueProps) {

        this.hazelcastInstance = hazelcastInstance;
        this.topicName = topicProps.request();
        this.queueBase = queueProps.base();
        this.partitionIndices = queueProps.partitions();
        this.deserializer = new ProtobufDeserializer<>(DisputeLookupRequestWrapperDto.parser());

        // Use your custom publisher
        this.publisher = new CustomHazelcastQueuePublisher(
                hazelcastInstance,
                new ProtobufSerializer<>()
        );
    }

    @PostConstruct
    public void start() {
        LOGGER.info("Topic Name: " + topicName);
        ITopic<byte[]> topic = hazelcastInstance.getReliableTopic(topicName);
        topic.addMessageListener(this);
        LOGGER.info("DisputeRouter started. Listening on DisputeRequestReliableTopic...");
    }

    @Override
    public void onMessage(Message<byte[]> message) {
        try {
            DisputeLookupRequestWrapperDto requestWrapper = deserializer.deserialize(message.getMessageObject());

            String correlationId = requestWrapper.getCorrelationId();
            String issuerId = requestWrapper.getIssuerId();
            String lockKey = "route-lock-" + correlationId;

            IMap<String, String> routerMap = hazelcastInstance.getMap("router-claim-map");
            String uniqueId = UUID.randomUUID().toString();

            String existing = routerMap.putIfAbsent(lockKey, uniqueId);

            if (existing != null) {
                LOGGER.info("Skipped duplicate routing for correlationId={}" + correlationId);
                return;
            }

            if(partitionIndices == null || partitionIndices.isEmpty()) {
                LOGGER.error("No partition indices configured. Routing aborted");
                return;
            }
            int index = Math.abs(issuerId.hashCode()) % partitionIndices.size();
            int partition = partitionIndices.get(index);

            String configKey = queueBase + partition;

            publisher.sendMessage(configKey, "DISPUTE_ROUTER", requestWrapper);

            LOGGER.info("Routed message with correlationId=" + correlationId + " to " + configKey);


        } catch (InvalidProtocolBufferException e) {
            LOGGER.error("Failed to deserialize message: " + e.getMessage());
        } catch (Exception e) {
            LOGGER.error("Routing failure: " + e.getMessage());
        }
    }

}
