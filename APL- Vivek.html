import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import osplus.pkptuna.rest.common.model.ApiResponse;
import java.util.UUID;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.TimeoutException;

@UiService(value = "publishDisputesLookupRequest", method = MethodType.GET, requiresAuthentication = false)
public ResponseEntity<ApiResponse<osplus.pkptuna.rest.dispute.lookup.model.DisputeLookupResponseDto>> publishDisputesLookupRequest(
        @ServiceParam("issuerId") String issuerId,
        @ServiceParam("cardReference") String cardReference) {

    try {
        String correlationId = UUID.randomUUID().toString();

        DisputeLookupRequestMetadataDto metadataDto = DisputeLookupRequestMetadataDto.newBuilder()
                .setRequestChannel("APL-UI")
                .setMessageType("DISPUTE_LOOKUP")
                .setRequestedBy("UI-MANUAL-TEST")
                .setBusinessContext("test")
                .build();

        DisputeLookupRequestDto request = DisputeLookupRequestDto.newBuilder()
                .setMetadata(metadataDto)
                .setIssuerId(issuerId)
                .setCardReference(cardReference)
                .build();

        DisputeLookupRequestWrapperDto wrapper = DisputeLookupRequestWrapperDto.newBuilder()
                .setCorrelationId(correlationId)
                .setPayload(request)
                .build();

        hazelcastInstance.getReliableTopic("DisputeLookupRequestReliableTopic")
                .publish(wrapper.toByteArray());

        disputeLookupResponseTracker.register(correlationId);
        CompletableFuture<DisputeLookupResponseDto> future = disputeLookupResponseTracker.await(correlationId);

        DisputeLookupResponseDto protoResponse = future.get(5, TimeUnit.SECONDS);
        osplus.pkptuna.rest.dispute.lookup.model.DisputeLookupResponseDto restResponse =
                disputeLookupResponseDtoMapper.toRestDto(protoResponse);

        return ResponseEntity.ok(new ApiResponse<>("success", null, restResponse));

    } catch (TimeoutException te) {
        return ResponseEntity.status(HttpStatus.REQUEST_TIMEOUT)
                .body(new ApiResponse<>("timeout", "No response in 5 seconds", null));

    } catch (Exception e) {
        LOGGER.error("Failed to process publishDisputesLookupRequest", e);
        return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR)
                .body(new ApiResponse<>("error", "Internal server error", null));
    }
}
