package osplus.pkptuna.hazelcast.pubsub;

import com.hazelcast.core.HazelcastInstance;
import com.hazelcast.map.IMap;
import com.hazelcast.map.listener.EntryAddedListener;
import com.hazelcast.map.listener.MapListener;
import com.hazelcast.map.listener.EntryUpdatedListener;
import com.hazelcast.map.listener.EntryEvictedListener;
import com.hazelcast.map.listener.EntryRemovedListener;
import com.hazelcast.map.listener.EntryExpiredListener;
import com.hazelcast.map.listener.EntryEvent;
import jakarta.annotation.PostConstruct;
import osplus.apl.core.api.AplComponent;
import osplus.fi.core.logging.api.Logger;
import osplus.fi.core.logging.api.LoggerFactory;
import osplus.pkptuna.dispute.lookup.model.DisputeLookupRequestWrapperDto;
import osplus.pkptuna.dispute.lookup.model.DisputeLookupResponseDto;
import osplus.pkptuna.dispute.lookup.model.DisputeLookupResponseWrapperDto;
import osplus.pkptuna.dispute.service.DisputeService;
import osplus.pkptuna.hazelcast.protobuf.impl.ProtobufSerializer;

@AplComponent
public class DisputeLookupMapConsumer {

    private static final Logger LOGGER = LoggerFactory.getLogger(DisputeLookupMapConsumer.class);

    private final HazelcastInstance hazelcastInstance;
    private final DisputeService disputeService;
    private final CustomHazelcastReliableTopicPublisher<DisputeLookupResponseWrapperDto> responsePublisher;
    private static final String MAP_NAME = "dispute-request-map";

    public DisputeLookupMapConsumer(HazelcastInstance hazelcastInstance,
                                    DisputeService disputeService) {
        this.hazelcastInstance = hazelcastInstance;
        this.disputeService = disputeService;
        this.responsePublisher = new CustomHazelcastReliableTopicPublisher<>(
                hazelcastInstance,
                new ProtobufSerializer<>()
        );
    }

    @PostConstruct
    public void listen() {
        IMap<String, DisputeLookupRequestWrapperDto> map = hazelcastInstance.getMap(MAP_NAME);
        MapListener listener = new EntryAddedListener<>() {
            @Override
            public void entryAdded(EntryEvent<String, DisputeLookupRequestWrapperDto> event) {
                processRequest(event.getKey(), event.getValue());
            }
        };
        map.addEntryListener(listener, true);
        LOGGER.info("DisputeLookupMapConsumer registered listener on map: {}", MAP_NAME);
    }

    private void processRequest(String key, DisputeLookupRequestWrapperDto request) {
        try {
            LOGGER.info("Processing request with correlationId: {}", request.getCorrelationId());

            DisputeLookupResponseDto result = disputeService.lookupDisputeFolder(
                    request.getIssuerId(), request.getCardReference()
            );

            DisputeLookupResponseWrapperDto response = DisputeLookupResponseWrapperDto.newBuilder()
                    .setCorrelationId(request.getCorrelationId())
                    .setResponse(result)
                    .build();

            responsePublisher.sendMessage("DisputeLookupResponseReliableTopic", "DISPUTE_WORKER", response);

            // Optional: remove from map after processing
            hazelcastInstance.getMap(MAP_NAME).remove(key);

            LOGGER.info("Processed and responded for correlationId: {}", request.getCorrelationId());
        } catch (Exception e) {
            LOGGER.error("Failed to process request: {}", e.getMessage(), e);
        }
    }
}
