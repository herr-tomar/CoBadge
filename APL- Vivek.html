package osplus.pkptuna.uimodule;

import com.hazelcast.core.HazelcastInstance;
import com.hazelcast.topic.ITopic;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mapstruct.factory.Mappers;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import osplus.pkptuna.api.ApiResponse;
import osplus.pkptuna.dispute.lookup.model.*;
import osplus.pkptuna.dispute.model.*;
import osplus.pkptuna.dispute.service.DisputeDetailService;
import osplus.pkptuna.dispute.service.DisputeService;
import osplus.pkptuna.rest.dispute.lookup.model.DisputeLookupResponseDtoMapper;
import osplus.pkptuna.rest.dispute.model.DisputeResponseDtoMapper;
import osplus.pkptuna.util.GenericResponseTracker;

import java.util.concurrent.CompletableFuture;
import java.util.concurrent.TimeoutException;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

class DisputeUiModuleTest {

    private DisputeUiModule disputeUiModule;
    private DisputeService disputeService;
    private DisputeDetailService disputeDetailService;
    private HazelcastInstance hazelcastInstance;
    private GenericResponseTracker<DisputeResponseDto> disputeDetailResponseTracker;
    private GenericResponseTracker<DisputeLookupResponseDto> disputeLookupResponseTracker;
    private DisputeLookupResponseDtoMapper disputeLookupResponseDtoMapper;
    private DisputeResponseDtoMapper disputeResponseDtoMapper;

    @BeforeEach
    void setUp() {
        disputeService = mock(DisputeService.class);
        disputeDetailService = mock(DisputeDetailService.class);
        hazelcastInstance = mock(HazelcastInstance.class);
        disputeDetailResponseTracker = mock(GenericResponseTracker.class);
        disputeLookupResponseTracker = mock(GenericResponseTracker.class);
        disputeLookupResponseDtoMapper = Mappers.getMapper(DisputeLookupResponseDtoMapper.class);
        disputeResponseDtoMapper = Mappers.getMapper(DisputeResponseDtoMapper.class);

        disputeUiModule = new DisputeUiModule(
                hazelcastInstance,
                disputeService,
                disputeDetailService,
                disputeDetailResponseTracker,
                disputeLookupResponseTracker,
                disputeLookupResponseDtoMapper,
                disputeResponseDtoMapper
        );
    }

    @Test
    void testLookupDisputeFolder() {
        DisputeLookupResponseDto protoDto = DisputeLookupResponseDto.getDefaultInstance();
        when(disputeService.lookupDisputeFolder(anyString(), anyString())).thenReturn(protoDto);

        ResponseEntity<ApiResponse<osplus.pkptuna.rest.dispute.lookup.model.DisputeLookupResponseDto>> response =
                disputeUiModule.lookupDisputeFolder("issuer", "cardRef");

        assertNotNull(response);
        assertEquals(200, response.getStatusCodeValue());
        assertEquals("success", response.getBody().getStatus());
    }

    @Test
    void testGetDisputeDetails() {
        DisputeResponseDto protoDto = DisputeResponseDto.getDefaultInstance();
        when(disputeDetailService.getDisputeFolderDetails(anyString(), anyString(), any())).thenReturn(protoDto);

        ResponseEntity<ApiResponse<osplus.pkptuna.rest.dispute.model.DisputeResponseDto>> response =
                disputeUiModule.getDisputeDetails("issuer", "ref", "events");

        assertNotNull(response);
        assertEquals(200, response.getStatusCodeValue());
        assertEquals("success", response.getBody().getStatus());
    }

    @Test
    void testPublishDisputesLookupRequest_success() throws Exception {
        ITopic<byte[]> topic = mock(ITopic.class);
        when(hazelcastInstance.getReliableTopic(anyString())).thenReturn(topic);

        CompletableFuture<DisputeLookupResponseDto> future = new CompletableFuture<>();
        future.complete(DisputeLookupResponseDto.getDefaultInstance());

        when(disputeLookupResponseTracker.await(anyString())).thenReturn(future);

        ResponseEntity<ApiResponse<osplus.pkptuna.rest.dispute.lookup.model.DisputeLookupResponseDto>> response =
                disputeUiModule.publishDisputesLookupRequest("issuer", "cardRef");

        assertEquals(200, response.getStatusCodeValue());
        assertEquals("success", response.getBody().getStatus());
    }

    @Test
    void testPublishDisputesLookupRequest_timeout() throws Exception {
        ITopic<byte[]> topic = mock(ITopic.class);
        when(hazelcastInstance.getReliableTopic(anyString())).thenReturn(topic);

        CompletableFuture<DisputeLookupResponseDto> future = mock(CompletableFuture.class);
        when(future.get(anyLong(), any())).thenThrow(new TimeoutException());
        when(disputeLookupResponseTracker.await(anyString())).thenReturn(future);

        ResponseEntity<ApiResponse<osplus.pkptuna.rest.dispute.lookup.model.DisputeLookupResponseDto>> response =
                disputeUiModule.publishDisputesLookupRequest("issuer", "cardRef");

        assertEquals(HttpStatus.REQUEST_TIMEOUT, response.getStatusCode());
        assertEquals("timeout", response.getBody().getStatus());
    }

    @Test
    void testPublishDisputeDetailRequest_success() throws Exception {
        ITopic<byte[]> topic = mock(ITopic.class);
        when(hazelcastInstance.getReliableTopic(anyString())).thenReturn(topic);

        CompletableFuture<DisputeResponseDto> future = new CompletableFuture<>();
        future.complete(DisputeResponseDto.getDefaultInstance());

        when(disputeDetailResponseTracker.await(anyString())).thenReturn(future);

        ResponseEntity<ApiResponse<osplus.pkptuna.rest.dispute.model.DisputeResponseDto>> response =
                disputeUiModule.publishDisputeDetailRequest("issuer", "ref123", "events");

        assertEquals(200, response.getStatusCodeValue());
        assertEquals("success", response.getBody().getStatus());
    }

    @Test
    void testPublishDisputeDetailRequest_timeout() throws Exception {
        ITopic<byte[]> topic = mock(ITopic.class);
        when(hazelcastInstance.getReliableTopic(anyString())).thenReturn(topic);

        CompletableFuture<DisputeResponseDto> future = mock(CompletableFuture.class);
        when(future.get(anyLong(), any())).thenThrow(new TimeoutException());
        when(disputeDetailResponseTracker.await(anyString())).thenReturn(future);

        ResponseEntity<ApiResponse<osplus.pkptuna.rest.dispute.model.DisputeResponseDto>> response =
                disputeUiModule.publishDisputeDetailRequest("issuer", "ref123", "events");

        assertEquals(HttpStatus.REQUEST_TIMEOUT, response.getStatusCode());
        assertEquals("timeout", response.getBody().getStatus());
    }

    @Test
    void testInitResponseListeners() {
        ITopic<byte[]> topic = mock(ITopic.class);
        when(hazelcastInstance.getReliableTopic(anyString())).thenReturn(topic);
        disputeUiModule.initResponseListeners();
        verify(hazelcastInstance, atLeast(2)).getReliableTopic(anyString());
    }
}
