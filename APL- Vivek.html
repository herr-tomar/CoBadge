@AplComponent
public class GenericHazelcastRouter {

    private final HazelcastInstance hazelcastInstance;
    private final HazelcastFlowProperties flowProperties;
    private final Map<String, AtomicInteger> partitionCounters = new ConcurrentHashMap<>();

    public GenericHazelcastRouter(HazelcastInstance hazelcastInstance, HazelcastFlowProperties flowProperties) {
        this.hazelcastInstance = hazelcastInstance;
        this.flowProperties = flowProperties;
    }

    @PostConstruct
    public void init() {
        for (HazelcastFlowConfig config : flowProperties.getFlows()) {
            ITopic<byte[]> topic = hazelcastInstance.getReliableTopic(config.topic());
            topic.addMessageListener(message -> handleMessage(config, message));
            partitionCounters.put(config.name(), new AtomicInteger(0));
        }
    }

    private void handleMessage(HazelcastFlowConfig config, Message<byte[]> message) {
        try {
            DisputeLookupRequestWrapperDto request = 
                DisputeLookupRequestWrapperDto.parser().parseFrom(message.getMessageObject());

            String correlationId = request.getCorrelationId();
            String mapName = config.baseMap() + (partitionCounters.get(config.name()).getAndIncrement() % config.partitions());

            hazelcastInstance.getMap(mapName)
                .put(correlationId, request, 30, TimeUnit.SECONDS);

            LoggerFactory.getLogger(getClass()).info(
                "üì• Routed to map {} for correlationId={}", mapName, correlationId
            );

        } catch (Exception e) {
            LoggerFactory.getLogger(getClass()).error("‚ùå Failed to handle message: {}", e.getMessage(), e);
        }
    }
}
