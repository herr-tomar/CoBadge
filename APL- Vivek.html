package com.example.plugin;

import com.google.protobuf.compiler.PluginProtos.CodeGeneratorRequest;
import com.google.protobuf.compiler.PluginProtos.CodeGeneratorResponse;

import java.io.*;

public class RestDtoGeneratorPlugin {
    public static void main(String[] args) throws Exception {
        // Read CodeGeneratorRequest from stdin
        CodeGeneratorRequest request = CodeGeneratorRequest.parseFrom(System.in);
        CodeGeneratorResponse.Builder responseBuilder = CodeGeneratorResponse.newBuilder();

        for (var file : request.getProtoFileList()) {
            if (!request.getFileToGenerateList().contains(file.getName())) continue;

            for (var message : file.getMessageTypeList()) {
                String className = message.getName() + "Dto";
                StringBuilder content = new StringBuilder();

                content.append("package com.example.dto;\n\n");
                content.append("public class ").append(className).append(" {\n");

                for (var field : message.getFieldList()) {
                    String javaType = mapType(field.getType().name());
                    content.append("    private ").append(javaType)
                           .append(" ").append(field.getName()).append(";\n");
                }

                content.append("}\n");

                // Build a file output entry
                responseBuilder.addFile(CodeGeneratorResponse.File.newBuilder()
                        .setName("com/example/dto/" + className + ".java")
                        .setContent(content.toString()));
            }
        }

        // Write CodeGeneratorResponse to stdout
        responseBuilder.build().writeTo(System.out);
    }

    private static String mapType(String protoType) {
        return switch (protoType) {
            case "TYPE_STRING" -> "String";
            case "TYPE_INT32" -> "int";
            case "TYPE_INT64" -> "long";
            case "TYPE_BOOL" -> "boolean";
            case "TYPE_DOUBLE" -> "double";
            case "TYPE_FLOAT" -> "float";
            default -> "Object";
        };
    }
}
