package osplus.pkptuna.util;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.google.protobuf.Message;
import com.google.protobuf.util.JsonFormat;

/**
 * Hilfsklasse zur Umwandlung von Protobuf-Nachrichten in saubere JSON-Darstellungen.
 */
public final class CleanProtoJsonUtil {

    private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();

    private CleanProtoJsonUtil() {
        // statische Hilfsklasse – kein Konstruktor
    }

    /**
     * Konvertiert eine Protobuf-Nachricht in eine JSON-Zeichenkette ohne Escape-Zeichen.
     *
     * @param message Protobuf-Nachricht
     * @return Sauberer JSON-String
     */
    public static String toCleanJson(Message message) {
        try {
            String rawJson = JsonFormat.printer().print(message);
            JsonNode tree = OBJECT_MAPPER.readTree(rawJson);  // parse string
            return OBJECT_MAPPER.writeValueAsString(tree);    // reserialize cleanly
        } catch (Exception e) {
            throw new RuntimeException("Fehler beim Konvertieren von Protobuf zu JSON", e);
        }
    }

    /**
     * Optional: Gibt formatierte (pretty) JSON-Ausgabe zurück.
     *
     * @param message Protobuf-Nachricht
     * @return Formatierter JSON-String
     */
    public static String toPrettyJson(Message message) {
        try {
            String rawJson = JsonFormat.printer().print(message);
            JsonNode tree = OBJECT_MAPPER.readTree(rawJson);
            return OBJECT_MAPPER.writerWithDefaultPrettyPrinter().writeValueAsString(tree);
        } catch (Exception e) {
            throw new RuntimeException("Fehler beim Formatieren von Protobuf als JSON", e);
        }
    }
}
