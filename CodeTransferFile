package osplus.pkptuna.hazelcast.pubsub;

import com.hazelcast.core.HazelcastInstance;
import com.hazelcast.map.IMap;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import osplus.pkptuna.hazelcast.config.HazelcastConfigProps;
import osplus.pkptuna.hazelcast.flows.FlowHandler;
import osplus.pkptuna.hazelcast.flows.FlowHandlerRegistry;
import osplus.pkptuna.hazelcast.test.config.BaseHazelcastTest;
import osplus.pkptuna.hazelcast.test.config.FlowHandlerTestConfiguration;

import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

import static org.junit.jupiter.api.Assertions.*;

public class GenericHazelcastConsumerTest extends BaseHazelcastTest {

    @Autowired
    private HazelcastConfigProps hazelcastConfigProps;

    @Autowired
    private FlowHandlerRegistry handlerRegistry;

    @Autowired
    private FlowHandler sampleFlowHandler;

    @Autowired
    private HazelcastInstance hazelcastInstance;

    @Autowired
    private GenericHazelcastConsumer consumer;

    @Autowired
    private FlowHandlerTestConfiguration.TestCollector testCollector;

    private IMap<Object, Object> requestMap;

    @BeforeEach
    public void setUp() {
        testCollector.clear();
        requestMap = hazelcastInstance.getMap("map-0");
        requestMap.clear();
    }

    @Test
    public void testPollRequestMaps_PositiveFlow() {
        Map<String, Object> request = new HashMap<>();
        request.put("key", "value");

        requestMap.put("corr-" + request.hashCode(), request);

        consumer.pollRequestMaps();

        assertTrue(testCollector.wasSent("res-topic"), "Expected response to be sent on topic");
        assertEquals("wrappedResponse", testCollector.getSent("res-topic"));
    }

    @Test
    public void testPollRequestMaps_NoHandlerFound() {
        IMap<Object, Object> unknownMap = hazelcastInstance.getMap("mapX-" + UUID.randomUUID());
        unknownMap.put("id1", "request");

        consumer.pollRequestMaps();

        assertFalse(testCollector.wasSent("res-topic"), "No response should be sent for unknown flow");
    }

    @Test
    public void testPollRequestMaps_HandlerThrowsException() {
        requestMap.put("id123", "faultyRequest");

        consumer.pollRequestMaps();

        assertFalse(testCollector.wasSent("res-topic"), "No response should be sent when handler fails");
    }
}
