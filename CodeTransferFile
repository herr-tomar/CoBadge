package osplus.pkp.dto.plugin;

import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.Writer;
import java.nio.file.Files;

import static org.junit.jupiter.api.Assertions.assertDoesNotThrow;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertThrows;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.junit.jupiter.api.Assertions.fail;

/**
 * Testklasse f체r das RestDtoGeneratorPlugin.
 */
class RestDtoGeneratorPluginTest {

    private File tempProtoDir;
    private File tempOutputDir;

    @BeforeEach
    void setUp() throws Exception {
        tempProtoDir = Files.createTempDirectory("proto-dir").toFile();
        tempOutputDir = Files.createTempDirectory("output-dir").toFile();

        // Simpler .proto-Datei erzeugen
        File protoFile = new File(tempProtoDir, "sample.proto");
        try (Writer writer = new FileWriter(protoFile)) {
            writer.write("""
                package osplus.sample;

                message Person {
                    string name = 1;
                    repeated int32 scores = 2;
                }
            """);
        }

        File templateDir = new File("src/main/resources/templates");
        templateDir.mkdirs();

        try (Writer writer = new FileWriter(new File(templateDir, "rest-dto.ftl"))) {
            writer.write("package ${packageName};\npublic class ${className} {}");
        }

        try (Writer writer = new FileWriter(new File(templateDir, "rest-mapper.ftl"))) {
            writer.write("package ${mapperPackage};\ninterface ${mapperInterfaceName} {}");
        }
    }

    @AfterEach
    void tearDown() {
        deleteRecursive(tempProtoDir);
        deleteRecursive(tempOutputDir);
    }

    private void deleteRecursive(File file) {
        if (file == null || !file.exists()) return;
        if (file.isDirectory()) {
            for (File child : file.listFiles()) {
                deleteRecursive(child);
            }
        }
        file.delete();
    }

    @Test
    void testSuccessfulGeneration() {
        assertDoesNotThrow(() -> RestDtoGeneratorPlugin.generate(
                new String[]{tempProtoDir.getAbsolutePath(), tempOutputDir.getAbsolutePath()}
        ));

        // Check if output was generated
        File[] generatedFiles = tempOutputDir.listFiles();
        assertNotNull(generatedFiles);
        assertTrue(generatedFiles.length > 0, "No output files generated.");
    }

    @Test
    void testMissingArguments() {
        IllegalArgumentException ex = assertThrows(IllegalArgumentException.class,
                () -> RestDtoGeneratorPlugin.generate(new String[0]));
        assertTrue(ex.getMessage().contains("Usage"));
    }

    @Test
    void testInvalidProtoDir() {
        String fakePath = new File("nonexistent").getAbsolutePath();
        IllegalArgumentException ex = assertThrows(IllegalArgumentException.class,
                () -> RestDtoGeneratorPlugin.generate(new String[]{fakePath, tempOutputDir.getAbsolutePath()}));
        assertTrue(ex.getMessage().contains("Ung체ltiges Proto-Verzeichnis"));
    }

    @Test
    void testWithEmptyProtoDir() {
        try {
            File emptyDir = Files.createTempDirectory("empty-proto").toFile();
            assertDoesNotThrow(() -> RestDtoGeneratorPlugin.generate(
                    new String[]{emptyDir.getAbsolutePath(), tempOutputDir.getAbsolutePath()}
            ));
            deleteRecursive(emptyDir); // still cleanup
        } catch (IOException e) {
            fail("Fehler beim Erstellen des tempor채ren Verzeichnisses f체r den Test: " + e.getMessage());
        }
    }

}
