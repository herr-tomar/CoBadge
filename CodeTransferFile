package osplus.pkptuna.hazelcast.pubsub;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.hazelcast.core.HazelcastInstance;
import com.hazelcast.map.IMap;
import com.hazelcast.topic.ITopic;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import osplus.pkptuna.hazelcast.config.FlowConfig;
import osplus.pkptuna.hazelcast.flows.FlowHandler;
import osplus.pkptuna.hazelcast.flows.FlowHandlerRegistry;
import osplus.pkptuna.hazelcast.test.config.BaseHazelcastTest;
import osplus.pkptuna.hazelcast.test.config.FlowHandlerTestConfiguration;

import java.util.Map;

import static java.util.concurrent.TimeUnit.MILLISECONDS;
import static java.util.concurrent.TimeUnit.SECONDS;
import static org.awaitility.Awaitility.await;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertFalse;

public class GenericHazelcastRouterTest extends BaseHazelcastTest {

    @Autowired private HazelcastInstance hazelcastInstance;
    @Autowired private FlowHandlerRegistry<String, FlowHandler> handlerRegistry;
    @Autowired private FlowHandler sampleFlowHandler;
    @Autowired private FlowConfig flowConfig;
    @Autowired private GenericHazelcastRouter router;
    @Autowired private FlowHandlerTestConfiguration.TestCollector testCollector;

    private IMap<String, String> leaderMap;
    private IMap<String, Long> heartbeatMap;
    private IMap<String, String> routerMap;
    private IMap<Object, Object> targetMap;
    private ITopic<byte[]> topic;

    private final String routerInstanceId = "test-router-instance";

    @BeforeEach
    public void setup() {
        leaderMap = hazelcastInstance.getMap("router-leader-map");
        heartbeatMap = hazelcastInstance.getMap("router-heartbeat-map");
        routerMap = hazelcastInstance.getMap("router-claim-map");
        targetMap = hazelcastInstance.getMap("map-0");

        leaderMap.clear();
        heartbeatMap.clear();
        routerMap.clear();
        targetMap.clear();
        testCollector.clear();

        router.setRouterInstanceId(routerInstanceId);
        topic = hazelcastInstance.getReliableTopic(flowConfig.requestTopic());
    }

    @Test
    public void testMessageRoutedSuccessfully() {
        // Make this router the leader
        leaderMap.put("active-router", routerInstanceId);
        heartbeatMap.put("heartbeat", System.currentTimeMillis());

        router.initRouters();
        topic.publish("{\"key\":\"value\"}".getBytes());

        await().atMost(1, SECONDS)
                .until(() -> testCollector.wasSent("res-topic"));

        assertEquals("wrappedResponse", testCollector.getSent("res-topic"));
    }

    @Test
    public void testDuplicateMessageNotProcessed() throws Exception {
        leaderMap.put("active-router", routerInstanceId);
        heartbeatMap.put("heartbeat", System.currentTimeMillis());

        router.initRouters();

        Map<String, Object> requestMap = Map.of("dup", "check");
        byte[] rawMessage = new ObjectMapper().writeValueAsBytes(requestMap);
        String corrId = sampleFlowHandler.extractCorrelationId(requestMap);

        routerMap.put("route-lock-" + corrId, "existing"); // Simulate existing lock
        topic.publish(rawMessage);

        await().during(300, MILLISECONDS)
              .atMost(1, SECONDS)
              .untilAsserted(() -> assertFalse(testCollector.wasSent("res-topic")));
    }

    @Test
    public void testRoutingHandlerThrowsException() {
        leaderMap.put("active-router", routerInstanceId);
        heartbeatMap.put("heartbeat", System.currentTimeMillis());

        router.initRouters();

        byte[] rawMessage = "faultyRequest".getBytes();
        topic.publish(rawMessage);

        await().during(300, MILLISECONDS)
              .atMost(1, SECONDS)
              .untilAsserted(() -> assertFalse(testCollector.wasSent("res-topic")));
    }

    @Test
    public void testNotLeaderDoesNotSubscribeToTopics() {
        // Simulate different leader
        leaderMap.put("active-router", "another-instance");
        heartbeatMap.put("heartbeat", System.currentTimeMillis());

        router.setRouterInstanceId("test-router-instance");
        router.initRouters();

        topic.publish("{\"key\":\"value\"}".getBytes());

        await().during(300, MILLISECONDS)
              .atMost(1, SECONDS)
              .untilAsserted(() -> assertFalse(testCollector.wasSent("res-topic")));
    }
}
