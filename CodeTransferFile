import com.google.protobuf.Message;
import com.google.protobuf.Parser;

import java.io.IOException;
import java.lang.reflect.Method;

public class ProtobufDeserializer<T extends Message> {

    private final Parser<T> parser;

    @SuppressWarnings("unchecked")
    public ProtobufDeserializer(Class<T> messageType) {
        try {
            Method parserMethod = messageType.getMethod("parser");
            this.parser = (Parser<T>) parserMethod.invoke(null);
        } catch (Exception e) {
            throw new IllegalStateException("Could not get parser for " + messageType.getName(), e);
        }
    }

    public T deserialize(byte[] data) throws IOException {
        return parser.parseFrom(data);
    }
}
