@TestConfiguration
static class FaultyHandlerTestConfig {

    // 1) Provide an EMPTY registry to prevent the default 'sampleFlowHandler' from being pre-registered
    @Bean
    public FlowHandlerRegistry<DummyMessage, DummyMessage, DummyMessage> handlerRegistry() {
        return new FlowHandlerRegistry<>();
    }

    // 2) Provide a handler that throws on handleRequest
    @Bean
    public FlowHandler<DummyMessage, DummyMessage, DummyMessage> faultyHandler() {
        FlowHandler<DummyMessage, DummyMessage, DummyMessage> handler = mock(FlowHandler.class);
        when(handler.getFlowName()).thenReturn("myFlow");
        when(handler.deserializeRequest(any())).thenReturn(new DummyMessage());
        when(handler.extractCorrelationId(any())).thenReturn("id123");
        when(handler.handleRequest(any())).thenThrow(new RuntimeException("boom!"));
        return handler;
    }

    // 3) Make sure the initializer sees ONLY this map
    @Bean
    public Map<String, FlowHandler> handlerMap(
            FlowHandler<DummyMessage, DummyMessage, DummyMessage> faultyHandler) {
        return Map.of("myFlow", faultyHandler);
    }
}
